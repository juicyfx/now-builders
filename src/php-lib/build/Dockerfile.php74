FROM amazonlinux:2.0.20190508

RUN yum install -y \
        https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm \
        https://rpms.remirepo.net/enterprise/remi-release-7.rpm \
        epel-release \
        yum-utils && \
    yum-config-manager --enable epel remi-test && \
    yum update -y && \
    yum upgrade -y

RUN yum install -y patchelf

RUN yum install -y \
        php74-php-bcmath \
        php74-php-cli \
        php74-php-cgi \
        php74-php-fpm \
        php74-php-gd \
        php74-php-imap \
        php74-php-intl \
        php74-php-json \
        php74-php-mbstring \
        php74-php-mysqli \
        php74-php-mysqlnd \
        php74-php-opcache \
        php74-php-pdo \
        php74-php-pgsql \
        php74-php-soap \
        php74-php-sodium \
        php74-php-tokenizer \
        php74-php-xml \
        php74-php-xmlrpc

# $ORIGIN refers to the current directory, don't evaluate it, use the single quotes
RUN patchelf --set-rpath '$ORIGIN' /usr/bin/php74
RUN patchelf --set-rpath '$ORIGIN' /usr/bin/php74-cgi
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/sbin/php-fpm
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/bcmath.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/bz2.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/calendar.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/ctype.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/curl.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/dom.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/exif.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/fileinfo.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/ftp.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/gd.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/gettext.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/iconv.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/imap.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/intl.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/json.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/mbstring.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/mysqli.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/mysqlnd.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/pdo.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/pdo_mysql.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/pdo_pgsql.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/pdo_sqlite.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/pgsql.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/phar.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/simplexml.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/soap.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/sockets.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/sodium.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/sqlite3.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/tokenizer.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/xml.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/xmlreader.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/xmlrpc.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/xmlwriter.so
RUN patchelf --set-rpath '$ORIGIN' /opt/remi/php74/root/usr/lib64/php/modules/xsl.so

WORKDIR /opt/now

ADD ./conf /opt/now/
ADD ./scripts /opt/now/
